name: Auto Deploy to Production

# Workflow pour faciliter le dÃ©ploiement de develop vers main
# Ã€ utiliser manuellement pour contrÃ´ler les mises en production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Confirmer le dÃ©ploiement en production (yes/no)'
        required: true
        default: 'no'

permissions:
  contents: write
  pull-requests: write

jobs:
  create-production-pr:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'yes'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check for differences
        id: check_diff
        run: |
          git fetch origin main
          DIFF=$(git diff origin/main...origin/develop --stat)
          if [ -z "$DIFF" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Pas de changements entre develop et main"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changements dÃ©tectÃ©s :"
            echo "$DIFF"
          fi
          
      - name: Create Pull Request
        if: steps.check_diff.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: develop
          base: main
          title: 'ðŸš€ Deploy to Production'
          body: |
            ## ðŸš€ DÃ©ploiement en Production
            
            Cette PR dÃ©ploie les derniers changements de `develop` vers `main` (production).
            
            ### ðŸ“‹ Checklist avant merge
            
            - [ ] Tous les articles ont Ã©tÃ© testÃ©s localement
            - [ ] Les workflows GitHub Actions sont verts
            - [ ] Le site compile sans erreur
            - [ ] Les liens ont Ã©tÃ© vÃ©rifiÃ©s
            - [ ] Le mode sombre fonctionne correctement
            - [ ] Les images sont optimisÃ©es
            - [ ] La documentation est Ã  jour
            
            ### ðŸ“Š Changements inclus
            
            <!-- GitHub affichera automatiquement le diff -->
            
            ### âš¡ AprÃ¨s le merge
            
            Le site sera automatiquement dÃ©ployÃ© sur GitHub Pages :
            - URL : https://theorbot42.github.io/blog/
            - DÃ©lai : ~1-2 minutes
            
            ### ðŸ§ª Tests post-dÃ©ploiement
            
            - [ ] VÃ©rifier le site en production
            - [ ] Tester sur mobile
            - [ ] VÃ©rifier tous les nouveaux articles
            - [ ] VÃ©rifier la navigation
            
            ---
            
            **GÃ©nÃ©rÃ© automatiquement par le workflow Auto Deploy**
          labels: |
            deployment
            production
          assignees: theorbot42
          
      - name: No changes detected
        if: steps.check_diff.outputs.has_changes == 'false'
        run: |
          echo "::warning::Aucun changement Ã  dÃ©ployer. develop et main sont identiques."
